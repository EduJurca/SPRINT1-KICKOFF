<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoltiaCar - Localitzar Vehicles</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS for maps -->
    <link
rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""
>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../css/custom.css">
    <link rel="stylesheet" href="../../css/accessibility.css">
    
    <!-- Tailwind Config -->
    <script src="../../css/tailwind.config.js"></script>
    
    <style>
        /* Amagar la barra de despla√ßament per a una aparen√ßa m√©s neta */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* Map container styling */
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem;
            z-index: 1;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <!-- Loading overlay -->
    <div id="auth-loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; font-size: 24px;">
        Verificando sesi√≥n...
    </div>
    
    <script>
        // Verificaci√≥n de sesi√≥n INMEDIATA - se ejecuta antes de cualquier otra cosa
        (async function() {
            console.log('üîç Iniciando verificaci√≥n de sesi√≥n...');
            try {
                const response = await fetch('/php/api/session-check.php', {
                    credentials: 'include'
                });
                
                console.log('üì° Respuesta recibida:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä Datos de sesi√≥n:', data);
                
                if (data.success && data.session.is_logged_in) {
                    console.log('‚úÖ Sesi√≥n v√°lida');
                    // Remover el overlay de loading
                    document.getElementById('auth-loading').style.display = 'none';
                } else {
                    console.error('‚ùå No autenticado');
                    alert('Debes iniciar sesi√≥n para acceder a esta p√°gina');
                    window.location.href = '/pages/auth/login.html';
                }
            } catch (error) {
                console.error('üí• Error:', error);
                alert('Error al verificar la sesi√≥n: ' + error.message);
                window.location.href = '/pages/auth/login.html';
            }
        })();
    </script>
    
    <div class="mobile-view md:hidden w-full max-w-sm h-[667px] flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-inner w-full h-full flex flex-col relative">
            <!-- Logo de la aplicaci√≥n -->
            <img
src="../../images/logo.png"
alt="Logo App"
class="absolute top-4 left-4 h-10 w-10 z-20"
>
            <a href="../dashboard/gestio.html" class="text-[#1565C0] text-sm font-semibold absolute top-[50.8px] left-4">‚Üê Tornar</a>
            <header class="flex items-center justify-start mb-6">
                <h1 class="text-2xl font-bold text-gray-900 flex-1 text-right">Localitzar Vehicles</h1>                <div id="map" class="h-48 w-full rounded-lg shadow-inner mb-4"></div>

                <!-- Secci√≥n de Vehicles propers -->
                <div class="flex-1 flex flex-col min-h-0 overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-gray-900">Vehicles propers</h2>
                        <button id="toggle-vehicles" class="flex items-center bg-gray-200 p-2 rounded-lg text-gray-700 hover:bg-gray-300 transition-colors duration-300">
                            <img
src="../../images/discapacidad.png"
alt="Vehicles discapacitats"
class="h-6 w-6"
>
                        </button>
                    </div>

                    <!-- Listas de veh√≠culos con scroll -->
                    <div class="flex-1 min-h-0 overflow-y-auto no-scrollbar">
                        <ul id="normal-list" class="space-y-4">
                            <li class="bg-gray-100 p-4 rounded-lg shadow-sm text-center text-gray-500">
                                Carregant vehicles...
                            </li>
                        </ul>

                        <ul id="special-list" class="space-y-4 hidden">
                            <li class="bg-gray-100 p-4 rounded-lg shadow-sm text-center text-gray-500">
                                Carregant vehicles accessibles...
                            </li>
                        </ul>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div class="desktop-view hidden md:flex bg-white p-8 rounded-2xl shadow-inner w-full max-w-6xl mx-auto flex md:flex-row space-x-4 relative min-h-[667px]">
        <!-- Map container on the left -->
        <div class="flex-shrink-0 w-1/2 flex flex-col">
            <div class="flex items-center space-x-6 mb-6">
                <img
src="../../images/logo.png"
alt="Logo App"
class="h-12 w-12"
>
                <a href="../dashboard/gestio.html" class="text-[#1565C0] text-lg font-semibold hover:underline">‚Üê Tornar</a>
            </div>
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Localitzar Vehicles</h2>
            <div id="map-desktop" class="rounded-lg shadow-inner flex-shrink-0 w-full min-h-[400px] max-h-[400px]"></div>
        </div>
        <!-- Vehicles list container on the right -->
        <div class="flex-1 flex flex-col min-h-0">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Vehicles propers</h2>
                <button id="toggle-vehicles-2" class="flex items-center bg-gray-200 p-2 rounded-lg text-gray-700 hover:bg-gray-300 transition-colors duration-300">
                    <img
src="../../images/discapacidad.png"
alt="Vehicles discapacitats"
class="h-6 w-6"
>
                </button>
            </div>
            <!-- Listas de veh√≠culos con scroll -->
            <div class="flex-1 min-h-0 overflow-y-auto no-scrollbar">
                <ul id="normal-list-2" class="space-y-4">
                    <li class="bg-gray-100 p-4 rounded-lg shadow-sm text-center text-gray-500">
                        Carregant vehicles...
                    </li>
                </ul>
                <ul id="special-list-2" class="space-y-4 hidden">
                    <li class="bg-gray-100 p-4 rounded-lg shadow-sm text-center text-gray-500">
                        Carregant vehicles accessibles...
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Session Check - MUST BE FIRST -->
    <script>
        // Variable global para indicar que la sesi√≥n est√° siendo verificada
        window.sessionCheckInProgress = true;
        window.sessionValid = false;
    </script>
    
    <!-- Application Scripts -->
    <script src="../../js/main.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/vehicles.js"></script>
    <script src="../../js/maps.js"></script>
    <script src="../../js/tutorial.js"></script>
    
    <script>
        // Store desktop map instance
        let desktopMapInstance = null;
        let desktopMarkers = [];
        
        // Initialize maps for both mobile and desktop
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ÔøΩ Inicializando mapas...');
            
            try {
                // Initialize mobile map
                const mapContainer = document.getElementById('map');
                if (mapContainer && !mapContainer._leaflet_id) {
                    console.log('üì± Inicializando mapa m√≥vil...');
                    await Maps.initMap('map', {
                        center: [41.3851, 2.1734],
                        zoom: 14
                    });
                    
                    // Load and display vehicles on mobile map
                    const vehicles = await Maps.loadVehicles();
                    Maps.updateVehicleLists(vehicles);
                } else if (mapContainer && mapContainer._leaflet_id) {
                    console.log('‚ö†Ô∏è Mapa m√≥vil ya inicializado');
                }
                
                // Initialize desktop map
                const mapDesktopContainer = document.getElementById('map-desktop');
                if (mapDesktopContainer && !mapDesktopContainer._leaflet_id) {
                    console.log('üñ•Ô∏è Inicializando mapa desktop...');
                    // Create a separate map instance for desktop
                    desktopMapInstance = L.map('map-desktop').setView([41.3851, 2.1734], 14);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        minZoom: 10,
                        maxZoom: 18
                    }).addTo(desktopMapInstance);
                    
                    // Get user location for desktop map
                    let userLocation = { lat: 41.3851, lng: 2.1734 }; // Default: Barcelona
                    
                    if ('geolocation' in navigator) {
                        try {
                            console.log('üìç Solicitando ubicaci√≥n del usuario...');
                            const position = await new Promise((resolve, reject) => {
                                navigator.geolocation.getCurrentPosition(resolve, reject, {
                                    enableHighAccuracy: false, // Cambiar a false para evitar demoras
                                    timeout: 5000,
                                    maximumAge: 60000 // Aceptar ubicaci√≥n de hasta 1 minuto
                                });
                            });
                            
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            console.log('‚úÖ Ubicaci√≥n obtenida:', userLocation);
                            
                            // Center map on user location
                            desktopMapInstance.setView([userLocation.lat, userLocation.lng], 15);
                            
                            // Add user marker
                            const userIcon = L.divIcon({
                                className: 'user-marker',
                                html: '<div style="width: 20px; height: 20px; background-color: #1565C0; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            });
                            
                            L.marker([userLocation.lat, userLocation.lng], {
                                icon: userIcon,
                                zIndexOffset: 1000
                            }).addTo(desktopMapInstance).bindPopup('<b>La teva ubicaci√≥</b>');
                            
                        } catch (error) {
                            console.warn('‚ö†Ô∏è No se pudo obtener la ubicaci√≥n:', error.message);
                            console.log('üìç Usando ubicaci√≥n por defecto (Barcelona)');
                            // userLocation ya tiene Barcelona como default
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Geolocalizaci√≥n no disponible en este navegador');
                    }
                    
                    // Load vehicles on desktop map
                    const vehicles = await Vehicles.getAvailableVehicles(userLocation);
                    console.log(`üìä ${vehicles.length} veh√≠culos cargados`);
                    
                    // Display vehicles on desktop map
                    vehicles.forEach(vehicle => {
                        if (vehicle.location) {
                            const color = vehicle.battery >= 80 ? '#10B981' : 
                                         vehicle.battery >= 50 ? '#F59E0B' : 
                                         vehicle.battery >= 20 ? '#F97316' : '#EF4444';
                            
                            const icon = L.divIcon({
                                className: 'vehicle-marker',
                                html: `
                                    <div style="position: relative; width: 40px; height: 40px;">
                                        <div style="width: 40px; height: 40px; background-color: ${color}; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 20px;">üöó</div>
                                        <div style="position: absolute; bottom: -5px; right: -5px; background-color: white; border: 2px solid ${color}; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: ${color};">${vehicle.battery}%</div>
                                    </div>
                                `,
                                iconSize: [40, 40],
                                iconAnchor: [20, 20],
                                popupAnchor: [0, -20]
                            });
                            
                            const distanceText = vehicle.distance !== undefined 
                                ? `<p style="margin: 4px 0;"><strong>Dist√†ncia:</strong> ${vehicle.distance.toFixed(2)} km</p>`
                                : '';
                            
                            const marker = L.marker([vehicle.location.lat, vehicle.location.lng], { icon }).addTo(desktopMapInstance);
                            
                            marker.bindPopup(`
                                <div style="min-width: 200px;">
                                    <h3 style="margin: 0 0 8px 0; font-weight: bold; color: #1565C0;">${vehicle.model}</h3>
                                    <p style="margin: 4px 0;"><strong>Matr√≠cula:</strong> ${vehicle.license_plate}</p>
                                    <p style="margin: 4px 0;"><strong>Bateria:</strong> <span style="color: ${color}; font-weight: bold;">${vehicle.battery}%</span></p>
                                    ${distanceText}
                                    <button onclick="Vehicles.claimVehicle(${vehicle.id})" style="margin-top: 12px; width: 100%; background-color: #1565C0; color: white; padding: 8px 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">Reclamar Vehicle</button>
                                </div>
                            `);
                            
                            desktopMarkers.push({ id: vehicle.id, marker: marker });
                        }
                    });
                    
                    // Update desktop vehicle lists
                    const normalList2 = document.getElementById('normal-list-2');
                    const specialList2 = document.getElementById('special-list-2');
                    
                    if (normalList2) {
                        Maps.renderVehicleList(normalList2, vehicles.filter(v => !v.is_accessible));
                    }
                    if (specialList2) {
                        Maps.renderVehicleList(specialList2, vehicles.filter(v => v.is_accessible));
                    }
                } else if (mapDesktopContainer && mapDesktopContainer._leaflet_id) {
                    console.log('‚ö†Ô∏è Mapa desktop ya inicializado');
                }
                
            } catch (error) {
                console.error('‚ùå Error initializing maps:', error);
                // Show error message to user
                const lists = document.querySelectorAll('#normal-list, #normal-list-2');
                lists.forEach(list => {
                    if (list) {
                        list.innerHTML = `
                            <li class="bg-red-100 p-4 rounded-lg shadow-sm text-center text-red-700">
                                Error en carregar els vehicles. Si us plau, torna-ho a intentar.
                            </li>
                        `;
                    }
                });
            }
            
            // Toggle functionality for vehicle lists
            const toggleButtons = document.querySelectorAll('#toggle-vehicles, #toggle-vehicles-2');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const parent = button.closest('.mobile-view') || button.closest('.desktop-view');
                    const normalList = parent.querySelector('[id^="normal-list"]');
                    const specialList = parent.querySelector('[id^="special-list"]');
                    
                    if (normalList && specialList) {
                        normalList.classList.toggle('hidden');
                        specialList.classList.toggle('hidden');
                    }
                });
            });
        });
    </script>
</body>
</html>