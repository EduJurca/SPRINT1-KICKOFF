<!DOCTYPE html>
<html lang="ca">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIMS - Perfil</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../../js/toast.js"></script>
  <style>
    .pushable {
      position: relative;
      border: none;
      border-radius: 12px;
      padding: 1rem 2rem;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      outline-offset: 4px;
      background: linear-gradient(180deg, #1565C0 0%, #0D47A1 100%);
      box-shadow: 0 6px #0D47A1;
      user-select: none;
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }

    .pushable:active {
      box-shadow: 0 3px #0D47A1;
      transform: translateY(3px);
    }

    .action-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 2rem 1rem;
      border-radius: 1rem;
      background-color: #E5E7EB;
      color: #1F2937;
      font-weight: 600;
      text-align: center;
      transition: background 0.3s;
    }

    .action-card:hover {
      background-color: #D1D5DB;
    }

    .action-card svg {
      width: 32px;
      height: 32px;
      fill: currentColor;
    }
  </style>
</head>

<body class="bg-gray-100 flex justify-center p-4 min-h-screen">

  <div class="w-full max-w-4xl bg-white p-6 rounded-2xl shadow-lg">

    <header class="w-full mb-6 grid grid-cols-3 items-center">
      <div class="text-left">
        <a href="../dashboard/gestio.html" class="text-[#1565C0] font-semibold hover:underline">← Tornar</a>
      </div>
      <h1 class="text-center text-2xl font-bold text-gray-900">Perfil</h1>
      <div class="flex justify-end">
        <img src="../../images/logo.png" alt="Logo" class="h-10 w-10">
      </div>
    </header>

    <div class="flex flex-col md:flex-row gap-8">
      <!-- Columna izquierda: Datos personales -->
      <div class="flex-shrink-0 w-full md:w-1/3 p-4">
        <h2 class="text-2xl font-bold mb-4 text-gray-900">Dades Personals</h2>
        <div class="space-y-3">
          <p><strong>Nom:</strong> <span id="fullname_span">Carregant...</span></p>
          <p><strong>DNI:</strong> <span id="dni_span">Carregant...</span></p>
          <p><strong>Telèfon:</strong> <span id="phone_span">Carregant...</span></p>
          <p><strong>Data naixement:</strong> <span id="birthdate_span">Carregant...</span></p>
          <p><strong>Adreça:</strong> <span id="address_span">Carregant...</span></p>
          <p><strong>Sexe:</strong> <span id="sex_span">Carregant...</span></p>
        </div>
        <div class="mt-4 flex gap-2">
          <button id="editBtn" class="pushable flex-1">Editar</button>
          <button id="saveBtn" class="pushable flex-1 bg-green-600 hidden">Guardar</button>
        </div>
      </div>

      <!-- Columna derecha: Acciones -->
      <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6">

        <a href="completar-perfil.html" class="action-card">
          <svg viewBox="0 0 24 24">
            <path
              d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12zm0 2.2c-3 0-9 1.5-9 4.5v2.2h18v-2.2c0-3-6-4.5-9-4.5z" />
          </svg>
          Completar Perfil
        </a>

        <a href="verificar-conduir.html" class="action-card">
          <svg viewBox="0 0 24 24">
            <path
              d="M20 2H4C2.9 2 2 2.9 2 4v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-9 16c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4z" />
          </svg>
          Verificar Carnet
        </a>

        <a href="historial.html" class="action-card">
          <svg viewBox="0 0 24 24">
            <path d="M13 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9H13V3z" />
          </svg>
          Històric Viatges
        </a>

        <a href="pagaments.html" class="action-card">
          <svg viewBox="0 0 24 24">
            <path
              d="M21 4H3c-1.1 0-2 .9-2 2v2h22V6c0-1.1-.9-2-2-2zm0 4H1v10c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8zm-2 3c0 .6-.4 1-1 1s-1-.4-1-1 .4-1 1-1 1 .4 1 1z" />
          </svg>
          Pagaments
        </a>

      </div>
    </div>
  </div>

  </div>

  <script>
document.addEventListener('DOMContentLoaded', function () {
  const fields = ['fullname', 'dni', 'phone', 'birthdate', 'address', 'sex'];
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  let profileData = {}; // Global variable to store fetched profile

  // Fetch profile on load
  fetch('/php/api/completar-perfil.php', { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      if (data.success && data.data) {
        profileData = data.data; // Store profile globally
        fields.forEach(f => {
          const span = document.getElementById(f + '_span');

          if (span) {
            if (f === 'fullname') {
              span.textContent = data.data[f] || data.data.username || 'Carregant...';
            } else if (data.data[f] !== undefined) {
              span.textContent = data.data[f];
            }
          }
        });
      }
    }).catch(console.error);

  // Edit button click
  editBtn.addEventListener('click', () => {
    fields.forEach(f => {
      const span = document.getElementById(f + '_span');
      const input = document.createElement('input');
      input.type = f === 'birthdate' ? 'date' : 'text';
      input.id = 'input_' + f;

      // If fullname is showing username, start with empty input
      input.value = (f === 'fullname' && span.textContent === profileData.username) ? '' : span.textContent;
      input.className = 'w-full px-2 py-1 border rounded';
      span.replaceWith(input);
    });

    editBtn.classList.add('hidden');
    saveBtn.classList.remove('hidden');
  });

  // Save button click
  saveBtn.addEventListener('click', () => {
    const updatedData = {};
    fields.forEach(f => {
      const input = document.getElementById('input_' + f);
      updatedData[f] = input.value.trim();
    });

    fetch('/php/api/completar-perfil.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(updatedData)
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          fields.forEach(f => {
            const input = document.getElementById('input_' + f);
            const span = document.createElement('span');
            span.id = f + '_span';

            // Show fullname if set, otherwise fallback to username
            if (f === 'fullname') {
              span.textContent = updatedData[f] || profileData.username || 'Carregant...';
              profileData.fullname = updatedData[f] || null; // Update global profile
            } else {
              span.textContent = updatedData[f];
              profileData[f] = updatedData[f]; // Update global profile
            }

            input.replaceWith(span);
          });

          editBtn.classList.remove('hidden');
          saveBtn.classList.add('hidden');
        } else {
          alert(data.message || 'Error al actualizar');
        }
      })
      .catch(console.error);
  });
});
</script>



</body>

</html>